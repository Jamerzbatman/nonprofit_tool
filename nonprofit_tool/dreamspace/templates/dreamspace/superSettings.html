<style>
/* Ensure the dropdown is visible above the modal */
.ui-autocomplete {
    z-index: 1050 !important; /* Bootstrap 5 modals use a z-index of 1050 */
}
.tooltip-container {
    position: relative;
    display: inline-block;
    margin-left: 8px;
}

.tooltip-icon {
    font-size: 1.2em;
    color: #007bff; /* Bootstrap primary color */
    cursor: pointer;
}
#WebSiteList {
    display: flex;
    flex-wrap: wrap; /* Allows cards to wrap to the next line if there are too many */
    gap: 10px; /* Adds space between cards */
}
.tooltip-text {
    visibility: hidden;
    width: 300px;
    background-color: #333;
    color: #fff;
    text-align: left;
    border-radius: 5px;
    padding: 10px;
    position: absolute;
    z-index: 1;
    bottom: 125%; /* Position above the icon */
    left: 50%;
    margin-left: -150px; /* Center the tooltip */
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip-container:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}
.btn-group {
    display: flex;
    gap: 0.5rem; /* Space between buttons */
}

.btn {
    border-radius: 0.25rem; /* Rounded corners */
}

.btn i {
    margin-right: 0.5rem; /* Space between icon and text */
}

.btn-secondary {
    font-weight: bold; /* Make the "Show All" button text bold */
}

</style>
<div class="container-fluid mt-5">
    <!-- Tab navigation -->
    <ul class="nav nav-tabs" id="websiteTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="dreamspace-tab" data-bs-toggle="tab" href="#dreamspace" role="tab" aria-controls="dreamspace" aria-selected="true">DreamSpace</a>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content" id="websiteTabContent">
        <!-- DreamSpace tab -->
        <div class="tab-pane fade show active" id="dreamspace" role="tabpanel" aria-labelledby="dreamspace-tab">
            <!-- Add App Button and Search Input -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDreamSpaceModal">
                    Add DreamSpace
                </button>

                <!-- Search Input aligned to the far right -->
                <div class="ms-auto" style="width: 300px;">
                    <input type="text" id="websiteSearch" class="form-control" placeholder="Search by name or tag...">
                </div>
            </div>
            <div id="WebSiteList" class="mt-3"></div>
        </div>

        <!-- Dynamic tabs for each website will be inserted here -->
    </div>
</div>

<!-- addDreamSpaceModal -->
<div class="modal fade" id="addDreamSpaceModal" tabindex="-1" aria-labelledby="addDreamSpaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDreamSpaceModalLabel">DreamSpace</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Error container -->
                <div id="formErrors"></div>

                <form id="AddDreamSpaceForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="AddDreamSpaceName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="AddDreamSpaceName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="AddDreamSpaceTags" class="form-label">
                            Tags
                            <span class="tooltip-container">
                                <i class="fas fa-question-circle tooltip-icon"></i>
                                <div class="tooltip-text">Tags help categorize and filter ideas based on themes, topics, or keywords.</div>
                            </span>
                        </label>
                        <input type="text" class="form-control" id="AddDreamSpaceTags" placeholder="Start typing to search tags...">
                        <input type="hidden" id="tags-input" name="tags">
                        <div id="tagsContainer"></div>
                    </div>
                    <div class="mb-3">
                        <label for="AddDreamSpaceDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="AddDreamSpaceDescription" name="description" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

document.getElementById('dreamspace-tab').addEventListener('click', function() {
    loadWebsitesList();
});
let websitesData = [];
// Function to load the list of apps
function loadWebsitesList() {
    fetch("{% url 'list_website' %}")
    .then(response => response.json())
    .then(data => {
        websitesData = data.WebSite; // Store the data globally
        displayWebsites(websitesData); // Display the websites
    })
    .catch(error => alertMessage("Error loading app list: " + error, 'alert alert-danger'));
}
// Function to display the filtered websites
function displayWebsites(websites) {
    const WebSiteList = document.getElementById('WebSiteList');
    WebSiteList.innerHTML = ''; // Clear existing list

    websites.forEach(WebSite => {
        const WebSiteBox = document.createElement('div');
        WebSiteBox.className = 'card mb-2';
        WebSiteBox.style.width = '500px'; // Set the width to make it narrower
        WebSiteBox.style.position = 'relative'; // Enable positioning of the hamburger button
        WebSiteBox.style.border = WebSite.error ? '2px solid red' : (WebSite.active ? '2px solid green' : '2px solid orange');

        WebSiteBox.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title" style="font-weight: bold;">${WebSite.name}</h5>
                    <!-- Hamburger Button at the top-right corner -->
                    <div class="dropdown" style="position: absolute; top: 10px; right: 10px;">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton-${WebSite.id}" data-bs-toggle="dropdown" aria-expanded="false">
                            &#9776; <!-- Three lines symbol -->
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton-${WebSite.id}">
                            <li>
                                <button class="dropdown-item" type="button" data-app-id="${WebSite.id}" onclick="openEditTab(${WebSite.id}, '${WebSite.name}')">
                                    Edit
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item" type="button" data-app-id="${WebSite.id}" onclick="Logs(${WebSite.id}, '${WebSite.name}')">
                                    Logs
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
                <p class="card-text" style="color: #6c757d; font-size: 14px; margin-top: 10px;">${WebSite.description}</p>
                
            </div>
        `;

        WebSiteList.appendChild(WebSiteBox);
    });
}
let logIntervals = {};  // Store interval IDs for different tabs
let currentFilters = {};  // Store current filters for different tabs

function Logs(id, name) {
    // Check if the tab already exists
    const existingTab = document.getElementById(`edit-tab-${id}`);
    if (existingTab) {
        // If the tab already exists, activate it
        const tab = new bootstrap.Tab(existingTab);
        tab.show();
        return;
    }

    // Create a new tab for editing the website
    const websiteTabs = document.getElementById('websiteTabs');
    const websiteTabContent = document.getElementById('websiteTabContent');

    const editTab = document.createElement('li');
    editTab.className = 'nav-item';
    editTab.innerHTML = `
        <a class="nav-link" id="edit-tab-${id}" data-bs-toggle="tab" href="#edit-${id}" role="tab" aria-controls="edit-${id}" aria-selected="false">
            Logs - ${name}
            <button type="button" onclick="closeWebsiteTabContent(${id})" class="close ms-2" aria-label="Close" style="color: white; padding-left: 10px;" data-tab-id="${id}">
                <span aria-hidden="true">&times;</span>
            </button>
        </a>
    `;
    websiteTabs.appendChild(editTab);

    const editTabPane = document.createElement('div');
    editTabPane.className = 'tab-pane fade';
    editTabPane.id = `edit-${id}`;
    editTabPane.role = 'tabpanel';
    editTabPane.ariaLabelledby = `edit-tab-${id}`;

    editTabPane.innerHTML = `
        <div class="btn-group" role="group" aria-label="Log Filters">
            <button type="button" class="btn btn-danger me-2" onclick="filterLogs('error', '${id}')">
                <i class="bi bi-x-circle"></i> Error
            </button>
            <button type="button" class="btn btn-success me-2" onclick="filterLogs('info', '${id}')">
                <i class="bi bi-info-circle"></i> Info
            </button>
            <button type="button" class="btn btn-warning me-2" onclick="filterLogs('debug', '${id}')">
                <i class="bi bi-bug"></i> Debug
            </button>
            <button type="button" class="btn btn-secondary" onclick="filterLogs('all', '${id}')">
                <i class="bi bi-filter"></i> Show All
            </button>
        </div>
        <div class="card-body" id="logs-container-${id}">
            <!-- Logs will be loaded here -->
        </div>
    `;
    websiteTabContent.appendChild(editTabPane);

    // Activate the new tab
    const tab = new bootstrap.Tab(editTab.querySelector('a'));
    tab.show();

    // Initialize filter type for this tab
    currentFilters[id] = 'all';

    // Fetch and display logs
    loadLogs(id);
}

function fetchLogs(id) {
    const filter = currentFilters[id] || 'all';  // Use the stored filter type

    fetch(`/dreamspace/list-logs/${id}/?filter=${filter}`)
        .then(response => response.json())
        .then(data => {
            allLogs = data.logs;  // Store logs globally
            filterLogs(filter, id);  // Apply the current filter
        })
        .catch(error => console.error('Error fetching logs:', error));
}

function filterLogs(type, id) {
    const logsContainer = document.getElementById(`logs-container-${id}`);

    if (!logsContainer) {
        console.error('Logs container not found');
        return;
    }

    // Store the current filter type for this tab
    currentFilters[id] = type;

    // If 'all' is selected, show all logs
    let filteredLogs = [];
    if (type === 'all') {
        filteredLogs = allLogs;
    } else {
        // Filter logs based on type
        filteredLogs = allLogs.filter(log => log.type.toLowerCase() === type.toLowerCase());
    }

    // Update the container with filtered logs
    logsContainer.innerHTML = filteredLogs.map(log => {
        let borderColor;
        switch (log.type.toLowerCase()) {
            case 'error':
                borderColor = '2px solid red';
                break;
            case 'info':
                borderColor = '2px solid green';
                break;
            default:
                borderColor = '2px solid orange';
                break;
        }
        return `
            <div class="card mb-2" style="border: ${borderColor};">
                <div class="card-body">
                    <p class="card-text"><strong>Message:</strong> ${log.message}</p>
                    <p class="card-text"><strong>Timestamp:</strong> ${new Date(log.timestamp).toLocaleString()}</p>
                </div>
            </div>
        `;
    }).join('');
}

function loadLogs(id) {
    // Initial load of logs with the current filter
    fetchLogs(id);

    // Set up an interval to reload logs every 10 seconds (10000 milliseconds)
    if (logIntervals[id]) {
        clearInterval(logIntervals[id]);  // Clear previous interval if it exists
    }
    logIntervals[id] = setInterval(() => fetchLogs(id), 10000);

    // Handle tab close functionality
    document.querySelector(`button[data-tab-id="${id}"]`).addEventListener('click', () => {
        if (logIntervals[id]) {
            clearInterval(logIntervals[id]);  // Stop the interval when the tab is closed
            delete logIntervals[id];  // Remove the interval ID from the object
        }
    });
}



function openEditTab(id, name) {
    // Check if the tab already exists
    const existingTab = document.getElementById(`edit-tab-${id}`);
    if (existingTab) {
        // If the tab already exists, activate it
        const tab = new bootstrap.Tab(existingTab);
        tab.show();
        return;
    }

    // Create a new tab for editing the website
    const websiteTabs = document.getElementById('websiteTabs');
    const websiteTabContent = document.getElementById('websiteTabContent');

    const editTab = document.createElement('li');
    editTab.className = 'nav-item';
    editTab.innerHTML = `
        <a class="nav-link" id="edit-tab-${id}" data-bs-toggle="tab" href="#edit-${id}" role="tab" aria-controls="edit-${id}" aria-selected="false">
            ${name}
            <button type="button" onclick="closeWebsiteTabContent(${id})" class="close ms-2" aria-label="Close" style="color: white; padding-left: 10px;"data-tab-id="${id}">
                <span aria-hidden="true">&times;</span>
            </button>
        </a>
    `;
    websiteTabs.appendChild(editTab);

    const editTabPane = document.createElement('div');
    editTabPane.className = 'tab-pane fade';
    editTabPane.id = `edit-${id}`;
    editTabPane.role = 'tabpanel';
    editTabPane.ariaLabelledby = `edit-tab-${id}`;

    editTabPane.innerHTML = `
        <div class="card-body">
            <h5 class="card-title">Edit ${name}</h5>
            <form id="EditWebSiteForm-${id}">
                <div class="mb-3">
                    <label for="EditWebSiteDescription-${id}" class="form-label">Description</label>
                    <textarea class="form-control" id="EditWebSiteDescription-${id}" name="description" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save changes</button>
            </form>
        </div>
    `;
    websiteTabContent.appendChild(editTabPane);

    // Activate the new tab
    const tab = new bootstrap.Tab(editTab.querySelector('a'));
    tab.show();
}

function closeWebsiteTabContent(id) {
    // Remove the tab link
    const tabLink = document.getElementById(`edit-tab-${id}`);
    const tabPane = document.getElementById(`edit-${id}`);

    if (tabLink) {
        // Remove the tab link
        tabLink.parentElement.remove();

        // Remove the corresponding tab pane
        if (tabPane) {
            tabPane.remove();
        }

        // Activate the first tab if available
        const firstTab = document.querySelector('#websiteTabs .nav-link');
        if (firstTab) {
            const firstTabPaneId = firstTab.getAttribute('href').substring(1);
            const firstTabPane = document.getElementById(firstTabPaneId);
            if (firstTabPane) {
                firstTab.classList.add('active');
                firstTabPane.classList.add('show', 'active');
            }
        }
    }
}
// Add event listener to the search input
document.getElementById('websiteSearch').addEventListener('input', function(event) {
    const searchQuery = event.target.value.toLowerCase();
    
    // Filter websites based on name or tags
    const filteredWebsites = websitesData.filter(WebSite => {
        const nameMatches = WebSite.name.toLowerCase().includes(searchQuery);
        const tagsMatch = WebSite.tags && WebSite.tags.some(tag => tag.toLowerCase().includes(searchQuery));
        return nameMatches || tagsMatch;
    });

    displayWebsites(filteredWebsites);
});
document.getElementById('AddDreamSpaceName').addEventListener('input', function() {
    let words = this.value.split(' ');
    for (let i = 0; i < words.length; i++) {
        words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1).toLowerCase();
    }
    this.value = words.join(' ');
});

let tags = [];

// Function to update the hidden input and display tags
function updateTags() {
    $('#tags-input').val(tags.join(','));
    
    // Clear the existing tags container
    $('#tagsContainer').empty();
    
    // Append each tag to the tags container
    tags.forEach(tag => {
        $('#tagsContainer').append(`<span class="badge bg-primary m-1">${tag}</span>`);
    });
}

// Handle keydown event for AddDreamSpaceTags input
$('#AddDreamSpaceTags').on('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const input = $(this).val().trim();
        if (input !== '' && !tags.includes(input)) {
            tags.push(input);
            $(this).val('');
            updateTags();
        }
    }
});

// Initialize autocomplete
$('#AddDreamSpaceTags').autocomplete({
    source: function(request, response) {
        $.ajax({
            url: "{% url 'tag_autocomplete' %}",
            dataType: 'json',
            data: {
                term: request.term
            },
            success: function(data) {
                response(data.tags);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    },
    select: function(event, ui) {
        if (!tags.includes(ui.item.value)) {
            tags.push(ui.item.value);
            $('#AddDreamSpaceTags').val('');
            updateTags();
        }
        return false;
    }
});



document.getElementById('AddDreamSpaceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    
    fetch("{% url 'add_website' %}", {
        method: "POST",
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#addDreamSpaceModal').modal('hide');
            $('#AddDreamSpaceForm')[0].reset();
            $('#tagsContainer').empty();
            $('#tags-input').val('');
            loadWebsitesList()
            openEditTab(data.id, data.name)
            alertMessage("DreamSpace Created", 'alert alert-success');
        } else {            
            if (data.errors) {
                alertMessage("Error: " + (data.errors || "Failed to save Website"), 'alert alert-danger');
            } else if (data.error) {
                alertMessage("Error: " + (data.error || "Failed to save Website"), 'alert alert-danger');
            }
        }
    })
    
    .catch(error => alertMessage("Error: " + (error || "Failed to save Website"), 'alert alert-danger'));

});

</script>