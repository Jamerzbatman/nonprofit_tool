<style>
#editFunctionModal .modal-dialog {
    max-width: 85%;
    width: auto;
    margin: 1.75rem auto;
}
#editFunctionModal .modal-dialog {
    max-width: 85%;
    width: auto;
    margin: 1.75rem auto;
}
.package-item {
    padding: 0px;
}
#appList {
    display: flex;
    flex-wrap: wrap; /* Allows cards to wrap to the next line if there are too many */
    gap: 10px; /* Adds space between cards */
}
.keyword {
    color: yellow;
}
.readonly {
    color: #ccc; /* Gray or any color to indicate it's read-only */
    font-style: italic;
}
.views {
    color: green;
}
.package-keyword-from {
    color: purple;
    font-weight: bold;
}

.package-after-from {
    color: green;
}

.package-keyword-import {
    color: purple;
    font-weight: bold;
}

.package-after-import {
    color: yellow;
}

.name {
    color: lightblue;
}

.quote {
    color: burlywood;
}
.parenthesis {
    color: yellow;
}

.col-md-4 {
    display: flex;
    flex-direction: column;
}

#openAIChat {
    flex-grow: 1;
    overflow-y: auto;
    word-wrap: break-word; /* Break long words */
    padding: 10px;
    word-break: break-word; /* Ensures long words break to prevent overflow */
    max-width: 100%; /* Ensure it doesn't extend beyond the column */
}

pre {
    white-space: pre-wrap; /* Ensure long text wraps */
    word-wrap: break-word;  /* Break long words to avoid overflow */
    background: transparent; /* Remove background to blend with the chat */
    border: none; /* Remove border */
    padding: 0; /* Remove padding */
    margin: 0; /* Remove margin */
    max-width: 100%; /* Ensure code block does not exceed container width */
    overflow: auto; /* Enable scrolling for long lines if necessary */
}
</style>
<!-- Add App Button -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAppModal">
    Add App
</button>



<!-- addFunctionModal -->
<div class="modal fade" id="addFunctionModal" tabindex="-1" aria-labelledby="addFunctionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFunctionModalLabel">Function Setup</h5>
                <button type="button" class="btn-close" onclick="hideAddFunctionModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addFunctionForm" onsubmit="submitFunctionForm(); return false;"></form>
                    <!-- Page 1 -->
                    <div id="addFunctionModalPage1" class="page">
                        <div class="mb-3">
                            <label for="functionName" class="form-label">Function Name</label>
                            <input type="text" class="form-control" id="functionName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="functionDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="functionDescription" name="description" rows="3"></textarea>
                        </div>
                    <button type="button" class="btn btn-primary mt-3" onclick="addFunctionModalNextPage()">Next</button>
                    </div>

                    <!-- Page 2 -->
                    <div id="addFunctionModalPage2" class="page d-none">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="functionURLResult" readonly>
                        </div>
                        <div class="mb-3">
                            <div id="pathParameterLinks">
                                <a href="#" class="path-param-link" data-param="<int:">Integer ID</a>
                                <a href="#" class="path-param-link" data-param="<str:">String (Slug)</a>
                                <a href="#" class="path-param-link" data-param="<uuid:">UUID</a>
                            </div>
                            <div id="parameterInputContainer" class="d-none">
                                <input type="text" class="form-control mt-2" id="parameterValueInput" placeholder="Enter value">
                                <button type="button" class="btn btn-success mt-2" id="addParameterButton">Add</button>
                            </div>
                        </div>
                        <button onclick="submitFunctionForm()" type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="addFunctionddModal" tabindex="-1" aria-labelledby="addFunctionModalLabel-${app.id}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFunctionModalLabel">Add Function for App</h5>
                <button type="button" class="btn-close" onclick="hideModal('#addFunctionModal')" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addFuncgggtionForm" onsubmit="submitFunctionForm(); return false;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="functionName" class="form-label">Function Name</label>
                                <input type="text" class="form-control" id="functionName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="functionURLResult" readonly>
                            </div>
                            <div class="mb-3">
                            <div id="pathParameterLinks">
                                <a href="#" class="path-param-link" data-param="<int:">Integer ID</a>
                                <a href="#" class="path-param-link" data-param="<str:">String (Slug)</a>
                                <a href="#" class="path-param-link" data-param="<uuid:">UUID</a>
                            </div>

                            </div>
                            <div class="mb-3">
                                <label for="functionDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="functionDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-info" id="toggleAISection">Toggle AI Section</button>
                            </div>
                            <!-- The section to be toggled -->
                            <div id="aiSection" style="display: none;">
                                <div class="mb-3">
                                    <label for="modelSelector" class="form-label">Select Models</label>
                                </br>
                                    <div id="modelButtonContainer" class="d-flex flex-wrap"></div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-secondary" id="generateFromOpenAI">Generate Function</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pipPackageName" placeholder="Package name">
                                    <button type="button" class="btn btn-primary" id="installPipPackage">Install</button>
                                </div>
                                <div id="list_packages"></div>
                            </div>
                            <div class="mb-3">
                                <label for="functionCodeEditor" class="form-label">Function Code</label>
                                <div id="functionCodeEditor" style="height: 200px; width: 100%;" name="code" ></div>
                            </div>
                        </div>
                        <div class="col-md-5 d-flex flex-column">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label for="openAIChat" class="form-label mb-0">Chat with OpenAI</label>
        
                                </div>
                                <div id="openAIChat">
                                    <!-- Chat messages will appear here -->
                                </div>
                            </div>
                            <div class="input-group mt-auto">
                                <input type="text" class="form-control" id="openAIInput" placeholder="Type your message...">
                                <button type="button" class="btn btn-primary" id="sendOpenAIMessage">Send</button>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Function</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Edit Functions Modal -->
<div class="modal fade" id="editFunctionModal" tabindex="-1" role="dialog" aria-labelledby="editFunctionModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editFunctionName">Edit Function</h5>
          <p id="editFunctionUrl"></p>
          <button type="button" class="btn-close" onclick="editFunctionCloseButton()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editFunctionForm">
            {% csrf_token %}
            <input type="hidden" id="editFunctionId" name="function_id">
            <div class="form-group">
                <a id="addPackageLink" class="add-package-link" href="#">Add Package</a>
                <div id="newPackageFields"></div>
                <div id="functionPackages"></div>
                <div id="newFunctionPackages"></div>
                
            </div>
            <div class="form-group">
              <label for="functionCode">Code</label>
              <!-- This div will be converted into the Ace editor -->
              <div id="editFunctionCodeEditor" style="height: 300px; width: 100%;"></div>
            </div>
            <div class="form-group">
              <label for="functionDescription">Description</label>
              <textarea class="form-control" id="editFunctionDescription" name="description" rows="3"></textarea>
            </div>
            <!-- Add other fields as needed -->
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="submitEditFunctionForm()">Save changes</button>
        </div>
      </div>
    </div>
  </div>
<!-- Functions Modal -->
<div class="modal fade" id="functionsModal" tabindex="-1" aria-labelledby="functionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="functionsModalLabel">Functions for App</h5>
                <button type="button" class="btn-close" onclick="hideModal('#functionsModal')" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="functionList"></div>
                <!-- Add Function Form Goes Here -->
            </div>
        </div>
    </div>
</div>
<!-- Add App Modal -->
<div class="modal fade" id="addAppModal" tabindex="-1" aria-labelledby="addAppModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAppModalLabel">Add New App</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Error container -->
                <div id="formErrors"></div>
                
                <form id="addAppForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="appName" class="form-label">App Name</label>
                        <input type="text" class="form-control" id="appName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="appDescription" class="form-label">App Description</label>
                        <textarea class="form-control" id="appDescription" name="description" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add App</button>
                </form>
                <div id="paymentList" class="mt-3">
                    <!-- Payment items will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Add Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Form for adding payments -->
                <form id="paymentForm">
                    <div class="mb-3">
                        <label for="paymentType" class="form-label">Payment Type</label>
                        <select class="form-select" id="paymentType" name="payment_type" required>
                            <option value="" disabled selected>Select type</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                            <option value="free">Free</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="paymentAmount" name="amount" step="0.01" required>
                    </div>
                    <input type="hidden" id="appId" name="app_id" value="">
                    <button type="submit" class="btn btn-primary">Add Payment</button>
                </form>

                <!-- Display added payments -->
                <div id="paymentList" class="mt-3">
                    <!-- Payment items will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Add Class Name Modal -->
<div class="modal fade" id="addClassNameModal" tabindex="-1" aria-labelledby="addClassNameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addClassNameModalLabel">Add New Class</h5>
                <button type="button" class="btn-close" onclick="hideAddClassNameModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="className" class="form-label">Class Name</label>
                    <input type="text" class="form-control" id="className">
                </div>
                <button type="button" class="btn btn-primary" onclick="showAddFieldsModal()">Next</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Fields Modal -->
<div class="modal fade" id="addFieldsModal" tabindex="-1" aria-labelledby="addFieldsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFieldsModalLabel">Add Fields to Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('text')">Text Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('textarea')">Text Area</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('integer')">Integer Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('decimal')">Decimal Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('float')">Float Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('date')">Date Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('datetime')">DateTime Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('boolean')">Boolean Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('image')">Image Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('file')">File Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('password')">Password Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('email')">Email Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('url')">URL Field</button>
                    <button type="button" class="btn btn-secondary" onclick="addFieldToClass('slug')">Slug Field</button>                </div>
                <div class="mb-3">
                    <textarea id="modelEditorDisplay" class="form-control" rows="10"></textarea>
                </div>
                <button type="button" class="btn btn-primary" onclick="saveClassToEditor()">Save Class</button>
            </div>
        </div>
    </div>
</div>

<!-- App List Container -->
<div id="appList" class="mt-3">
    <!-- Apps will be listed here -->
</div>

<script>
document.getElementById('app_management-tab').addEventListener('click', function() {
    loadAppList();
});
document.addEventListener('DOMContentLoaded', function() {

    appList.addEventListener('click', function(event) {
        if (event.target.matches('[data-bs-toggle="modal"]')) {
            const appId = event.target.getAttribute('data-app-id');

            // Set hidden input field for app ID
            document.getElementById(`appId-${appId}`).value = appId;

            // Load existing payments for the selected app
            loadPayments(appId);
        }
    });
});

function loadFunctions(appId) {    
    fetch(`/apps/${appId}/functions/`)
        .then(response => response.json())
        .then(data => {
            const functionsModal = document.getElementById(`functionsModal`);
            const modal = new bootstrap.Modal(functionsModal); 
            const functionList = document.getElementById(`functionList`);
            if (functionList) {
                functionList.innerHTML = ''; // Clear existing content
                
                if (data.success && data.functions.length > 0) {
                    let listHTML = data.functions.map(func => `
                        <button class="btn btn-outline-secondary btn-block mb-2 text-start function-item" onclick="editFunction(${func.id})">
                            <h6 class="mb-1">${func.name}</h6>
                            <p class="mb-0">${func.description}</p>
                        </button>
                    `).join('');

                    // Add the "Add a Function" button under the list
                    listHTML += `
                        <button class="btn btn-primary mt-3" onclick="addFunction()">Add a Function</button>
                    `;

                    functionList.innerHTML = listHTML;
                } else {
                    functionList.innerHTML = `
                        <p>No functions found for this app.</p>
                        <button class="btn btn-primary" onclick="addFunction()">Add a Function</button>
                    `;
                }
            } else {
                console.error(`Element with id="functionList-${appId}" does not exist in the DOM.`);
            }
            modal.show();
        })
        .catch(error => console.error('Error fetching functions:', error));
}

// Fetch and display models as buttons for selection
function fetchModels(appId) {
    fetch(`/apps/get-models/${appId}/`)
    .then(response => response.json())
    .then(data => {
        const modelButtonContainer = document.getElementById('modelButtonContainer');
        modelButtonContainer.innerHTML = '';  // Clear existing buttons

        if (data.models) {
            data.models.forEach(model => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-primary m-1';  // Default styling for unselected button
                button.innerText = model;
                button.value = model;

                // Toggle effect for selection/deselection
                button.addEventListener('click', function() {
                    if (button.classList.contains('btn-outline-primary')) {
                        button.classList.remove('btn-outline-primary');
                        button.classList.add('btn-primary');  // Change styling to indicate selection
                        button.setAttribute('data-selected', 'true');  // Mark as selected
                    } else {
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-outline-primary');  // Revert to default styling
                        button.removeAttribute('data-selected');  // Mark as deselected
                    }
                });

                modelButtonContainer.appendChild(button);
            });
        } else if (data.error) {
            console.error(data.error);
        }
    })
    .catch(error => console.error('Error fetching models:', error));
}

let editor;
let installPipButtonClicked = false;  // Flag to track if the button's event listener is added
let isReadOnly = false;


function addFunctionModalNextPage() {
    document.getElementById('addFunctionModalPage1').classList.add('d-none');
    document.getElementById('addFunctionModalPage2').classList.remove('d-none');
}

function addFunction() {
    hideModal(`#functionsModal`);    
    const modalElement = document.getElementById('addFunctionModal');
    const functionNameInput = document.getElementById('functionName');
    const functionDescriptionInput = document.getElementById('functionDescription');
    const functionUrlElement = document.getElementById('functionURLResult');
    const paramInputContainer = document.getElementById('parameterInputContainer');
    const paramValueInput = document.getElementById('parameterValueInput');
    const addParameterButton = document.getElementById('addParameterButton');

    if (functionNameInput) functionNameInput.value = '';
    if (functionDescriptionInput) functionDescriptionInput.value = '';

    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    document.getElementById('addFunctionModalPage1').classList.remove('d-none');
    document.getElementById('addFunctionModalPage2').classList.add('d-none');

    // Hide parameter input container initially
    if (paramInputContainer) paramInputContainer.classList.add('d-none');
    if (paramValueInput) paramValueInput.value = '';

    if (functionUrlElement) {
        const functionUrlContainer = functionUrlElement.closest(".mb-3");
        functionUrlContainer.innerHTML = `
            <div class="form-inline mb-3">
                <span class="keyword">path(</span>
                <span class="quote">'</span>
                <span class="quote" id="inputPathPart"></span>
                <span class="quote">/'</span>
                <span>, </span>
                <span class="views">views.</span>
                <span class="keyword" id="inputViewPart"></span> 
                <span class="name">, name=</span>
                <span class="quote">'</span>
                <span class="quote" id="inputNamePart"></span>
                <span class="quote">'</span>
                <span class="keyword">)</span>
            </div>
        `;
    }

    functionNameInput.addEventListener('input', function() {
        const sanitizedValue = functionNameInput.value.trim().toLowerCase().replace(/\s+/g, '_');
        const urlSanitizedValue = functionNameInput.value.trim().toLowerCase().replace(/\s+/g, '-');
        const inputPathPart = document.getElementById('inputPathPart');
        const inputViewPart = document.getElementById('inputViewPart');
        const inputNamePart = document.getElementById('inputNamePart');

        if (inputPathPart) inputPathPart.textContent = urlSanitizedValue;
        if (inputViewPart) inputViewPart.textContent = sanitizedValue;
        if (inputNamePart) inputNamePart.textContent = sanitizedValue;
    });

    // Handle path parameter link clicks
    document.querySelectorAll('#pathParameterLinks .path-param-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            let param = this.getAttribute('data-param'); 

            // Show input field and button
            if (paramInputContainer) paramInputContainer.classList.remove('d-none');
            if (paramValueInput) paramValueInput.focus();

            // Move the event listener for the addParameterButton outside the parameter link event
            addParameterButton.addEventListener('click', () => {
                const NameParamValueInput = document.getElementById('parameterValueInput');
                const inputPathPart = document.getElementById('inputPathPart');
                const currentPath = inputPathPart.textContent || '';
                const paramName = NameParamValueInput.value.trim().toLowerCase().replace(/\s+/g, '-');

                if (paramName) {
                    // Ensure proper path formatting
                    const newPathPart = currentPath.endsWith('/')
                        ? `${currentPath}${param}${paramName}>`
                        : `${currentPath}/${param}${paramName}>`;
                    console.info(newPathPart);
                    inputPathPart.textContent = newPathPart;

                    // Clear input and hide container
                    NameParamValueInput.value = "";
                    if (paramInputContainer) paramInputContainer.classList.add('d-none');
                }
            });

            document.querySelectorAll('#pathParameterLinks .path-param-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    param = this.getAttribute('data-param'); // Use let to keep param in scope
                    // Show input field and button
                    if (paramInputContainer) paramInputContainer.classList.remove('d-none');
                    if (paramValueInput) paramValueInput.focus();
                });
            }); 
        });   

    });    
}


function OldAddFunction(appId) {
    const functionsModal = document.getElementById('addFunctionModal');
    const modal = new bootstrap.Modal(functionsModal);
    const modelSelector = document.getElementById('modelSelector');
    const toggleButton = document.getElementById('toggleAISection');
    const aiSection = document.getElementById('aiSection');
    const pathParameterInput = document.getElementById('pathParameter');
    const pathParameterLinks = document.getElementById('pathParameterLinks');
    // Function to clear all modal content
    function clearModalContent() {
        // Clear input fields
        const functionNameInput = document.getElementById('functionName');
        const functionDescriptionInput = document.getElementById('functionDescription');
        const pipPackageNameInput = document.getElementById('pipPackageName');
        const inputPathPart = document.getElementById('inputPathPart');
        const inputViewPart = document.getElementById('inputViewPart');
        const inputNamePart = document.getElementById('inputNamePart');
        
        if (functionNameInput) functionNameInput.value = '';
        if (functionDescriptionInput) functionDescriptionInput.value = '';
        if (pipPackageNameInput) pipPackageNameInput.value = '';
        if (inputPathPart) inputPathPart.textContent = '';
        if (inputViewPart) inputViewPart.textContent = '';
        if (inputNamePart) inputNamePart.textContent = '';

        // Clear the list_packages div
        const listPackagesDiv = document.getElementById('list_packages');
        if (listPackagesDiv) listPackagesDiv.innerHTML = '';

        const editorElement = document.getElementById("functionCodeEditor");
        if (editor) {
            editor.setValue('');
        } else {
            editor = ace.edit(editorElement);
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/python");
        }
    }
    functionsModal.addEventListener('hidden.bs.modal', clearModalContent);
    clearModalContent();
    const listPackagesDiv = document.getElementById('list_packages');
    const packageItem = document.createElement('div');
    listPackagesDiv.innerHTML = '';
    packageItem.textContent = 'from app_management.utils import log_error';
    listPackagesDiv.appendChild(packageItem);

    toggleButton.addEventListener('click', function() {
        if (aiSection.style.display === 'none' || aiSection.style.display === '') {
            aiSection.style.display = 'block'; // Show the section
            toggleButton.textContent = 'Hide AI Section'; // Update button text
        } else {
            aiSection.style.display = 'none'; // Hide the section
            toggleButton.textContent = 'Show AI Section'; // Update button text
        }
    });
    fetchModels(appId);

    // Find and remove the existing `functionURLResult` element
    const functionUrlElement = document.getElementById('functionURLResult');
    if (functionUrlElement) {
        const functionUrlContainer = functionUrlElement.closest(".mb-3");
        functionUrlContainer.innerHTML = `
            <div class="form-inline mb-3">
                <span>path('</span>
                <span id="inputPathPart"></span>
                <span>/', views.</span>
                <span id="inputViewPart"></span> 
                <span>, name='</span>
                <span id="inputNamePart"></span>
                <span>')</span>
            </div>
        `;

        const functionNameInput = document.getElementById('functionName');
        const inputPathPart = document.getElementById('inputPathPart');
        functionNameInput.addEventListener('input', function() {
            const sanitizedValue = functionNameInput.value.trim().toLowerCase().replace(/\s+/g, '_');
            const urlSanitizedValue = functionNameInput.value.trim().toLowerCase().replace(/\s+/g, '-');
            editor.setValue(
    `
def ${sanitizedValue}(request):
    try:
        # Code goes here...
    except Exception as e:
        log_error('${currentAppId}', '${sanitizedValue}', str(e))
`
);
            document.getElementById('inputPathPart').textContent = urlSanitizedValue;
            document.getElementById('inputViewPart').textContent = sanitizedValue;
            document.getElementById('inputNamePart').textContent = sanitizedValue;

            editor.clearSelection(); 
        });
        // Add event listeners to path parameter links
        pathParameterLinks.addEventListener('click', function(event) {
            if (event.target.classList.contains('path-param-link')) {
                event.preventDefault();  // Prevent default link behavior
                const parameter = event.target.getAttribute('data-param');
                const paramName = prompt("Enter a name for the parameter (e.g., 'id', 'slug'):");
                if (paramName) {
                    const currentPath = inputPathPart.textContent;
                    inputPathPart.textContent = `${currentPath}/${parameter}${paramName}>`;
                }
            }
        });
        inputViewPart.addEventListener('input', function() {
            const sanitizedFunctionName = inputViewPart.value.trim().toLowerCase().replace(/\s+/g, '_');
            editor.setValue(`def ${sanitizedFunctionName}(request):\n    # Code goes here...\n`);
            editor.clearSelection();  // Remove selection so the text doesn't appear selected
        });
    }

    // Define functionPackagesDiv to avoid the reference error
    const functionPackagesDiv = document.getElementById('functionPackages');

    // Initialize Ace Editor only once
    if (!editor) {
        const editorElement = document.getElementById("functionCodeEditor");
        editor = ace.edit(editorElement);  // Initialize the editor
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python"); 
    }

    // Handle Pip Package Installation
    const installPipButton = document.getElementById('installPipPackage');
    const pipPackageNameInput = document.getElementById('pipPackageName');

    // Add event listener only if not already added
    if (!installPipButtonClicked) {
        installPipButton.addEventListener('click', function() {
            const packageName = pipPackageNameInput.value.trim();

            // Check if the package name is provided
            if (packageName) {
                // Disable the button to prevent multiple clicks
                installPipButton.disabled = true;

                fetch('/apps/install-pip-package/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()  // Assumes you have a function to get the CSRF token
                    },
                    body: JSON.stringify({ package_name: packageName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        pipPackageNameInput.value = `Package ${packageName} installed successfully!`;
                        alertMessage(`Package ${packageName} installed successfully!`, 'alert alert-success');

                        // Update the list_packages div with the newly installed package
                        const listPackagesDiv = document.getElementById('list_packages');
                        const packageItem = document.createElement('div');
                        packageItem.textContent = packageName;
                        listPackagesDiv.appendChild(packageItem);

                        // Clear the input field after 3 seconds
                        setTimeout(function() {
                            pipPackageNameInput.value = ``;
                        }, 3000);
                    } else {
                        alert(`Failed to install package: ${data.error}`);
                        alertMessage(`Failed to install package: ${data.error}`, 'alert alert-danger');
                    }
                })
                .catch(error => console.error('Error installing package:', error))
                .finally(() => {
                    // Re-enable the button after the operation is complete
                    installPipButton.disabled = false;
                });
            }
        });
        installPipButtonClicked = true; // Update flag after adding listener
    }

    modal.show();
    hideModal(`#functionsModal`);
}


document.getElementById('addAppForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    
    fetch("{% url 'create_app' %}", {
        method: "POST",
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#addAppModal').modal('hide');
            alertMessage("App Created", 'alert alert-success');
            loadAppList(); // Reload the app list
        } else {
            const errorContainer = document.getElementById('formErrors');
            errorContainer.innerHTML = ''; // Clear any previous errors
            
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    const errorElement = document.createElement('div');
                    errorElement.className = 'alert alert-danger';
                    errorElement.textContent = `${field}: ${errors.join(', ')}`;
                    errorContainer.appendChild(errorElement);
                }
            } else if (data.error) {
                const errorElement = document.createElement('div');
                errorElement.className = 'alert alert-danger';
                errorElement.textContent = data.error;
                errorContainer.appendChild(errorElement);
            }
        }
    })
    .catch(error => console.error('Error:', error));
});

// Function to load the list of apps
function loadAppList() {
    fetch("{% url 'list_apps' %}")
    .then(response => response.json())
    .then(data => {
        const appList = document.getElementById('appList');
        appList.innerHTML = ''; // Clear existing list

        data.apps.forEach(app => {
            const appBox = document.createElement('div');
            appBox.className = 'card mb-2';
            appBox.style.width = '200px'; // Set the width to make it narrower
            appBox.style.height = '100px'; // Set the height to make it taller
            appBox.style.position = 'relative'; // Enable positioning of the hamburger button

            appBox.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">${formatAppName(app.name)}</h5>
                    
                    <!-- Hamburger Button at the top-right corner -->
                    <div class="dropdown" style="position: absolute; top: 10px; right: 10px;">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton-${app.id}" data-bs-toggle="dropdown" aria-expanded="false">
                            &#9776; <!-- Three lines symbol -->
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton-${app.id}">
                            <li>
                                <button class="dropdown-item" type="button" data-app-id="${app.id}" data-bs-toggle="modal" data-bs-target="#paymentModal-${app.id}">
                                    Payment
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item" type="button" data-app-id="${app.id}" onclick="showModelsModal(${app.id})">
                                    Models
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item" type="button" data-app-id="${app.id}" onclick="addFunctionModal(${app.id})">
                                    Functions
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            `;

            appList.appendChild(appBox);

            // Payment Modal
            const paymentModal = document.createElement('div');
            paymentModal.className = 'modal fade';
            paymentModal.id = `paymentModal-${app.id}`;
            paymentModal.tabIndex = '-1';
            paymentModal.setAttribute('aria-labelledby', `paymentModalLabel-${app.id}`);
            paymentModal.setAttribute('aria-hidden', 'true');
            paymentModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="paymentModalLabel-${app.id}">Payment Details for ${formatAppName(app.name)}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="paymentForm-${app.id}">
                                {% csrf_token %}
                                <input type="hidden" id="appId-${app.id}" name="app_id" value="${app.id}">
                                <div class="mb-3">
                                    <label for="paymentType-${app.id}" class="form-label">Payment Type</label>
                                    <select class="form-select" id="paymentType-${app.id}" name="payment_type" data-app-id="${app.id}" required>
                                        <option value="once">One Time</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                        <option value="free">Free</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="paymentAmount-${app.id}" class="form-label">Amount</label>
                                    <input type="number" class="form-control" id="paymentAmount-${app.id}" name="amount" step="0.01" min="0" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Payment Details</button>
                            </form>
                            <div id="paymentList-${app.id}" class="mt-3">
                                <!-- Payment items will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            appList.appendChild(paymentModal);

        });

        // Attach event listener to the payment form
        document.querySelectorAll('[id^="paymentForm-"]').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(e.target);

                fetch(`/apps/${form.querySelector('input[name="app_id"]').value}/payment/`, {
                    method: "POST",
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    },
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alertMessage("Payment Details Saved", 'alert alert-success');
                        loadPayments(form.querySelector('input[name="app_id"]').value);
                    } else {
                        alertMessage("Error: " + (data.error || "Failed to save payment details"), 'alert alert-danger');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });

        // Attach event listener to the payment type select to disable amount input if 'Free' is selected
        document.querySelectorAll('[id^="paymentType-"]').forEach(select => {
            const paymentAmountInput = document.getElementById(`paymentAmount-${select.dataset.appId}`);
            select.addEventListener('change', function() {
                if (select.value === 'free') {
                    paymentAmountInput.value = '00.00'; // Set value to 00.00
                    paymentAmountInput.style.color = 'black';
                    paymentAmountInput.disabled = true;
                } else {
                    paymentAmountInput.value = '';
                    paymentAmountInput.disabled = false;
                }
            });

            // Initial check to disable amount input if 'Free' is selected by default
            if (select.value === 'free') {
                paymentAmountInput.disabled = true;
            }
        });


    })
    .catch(error => console.error('Error loading app list:', error));
}



function formatAppName(name) {
    return name.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
}

// Handle payment form submission
document.getElementById('paymentForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    const paymentType = formData.get('payment_type');
    const amount = formData.get('amount');

    if (paymentType && amount) {
        const paymentItem = document.createElement('div');
        paymentItem.className = 'payment-item mb-2 d-flex justify-content-between align-items-center';
        paymentItem.innerHTML = `
            <div>
                ${paymentType} - $${amount}
            </div>
            <div>
                <button type="button" class="btn btn-warning btn-sm me-2 edit-payment">Edit</button>
                <button type="button" class="btn btn-danger btn-sm delete-payment">Delete</button>
            </div>
        `;

        const paymentList = document.getElementById('paymentList');
        paymentList.appendChild(paymentItem);

        // Clear form inputs
        form.reset();

        // Add event listeners for edit and delete buttons
        paymentItem.querySelector('.edit-payment').addEventListener('click', function() {
            const newType = prompt('Enter new payment type:', paymentType);
            const newAmount = prompt('Enter new amount:', amount);
            if (newType && newAmount) {
                paymentItem.querySelector('div').innerHTML = `${newType} - $${newAmount}`;
            }
        });

        paymentItem.querySelector('.delete-payment').addEventListener('click', function() {
            paymentItem.remove();
        });
    }
});

// Function to load payments into the modal
function loadPayments(appId) {
    const paymentList = document.getElementById(`paymentList-${appId}`);
    if (!paymentList) {
        console.error(`No payment list found for app ID ${appId}`);
        return;
    }

    fetch(`/apps/fetch/${appId}/payments/`)
    .then(response => response.json())
    .then(data => {
        paymentList.innerHTML = ''; // Clear existing payments

        data.payments.forEach(payment => {
            const paymentItem = document.createElement('div');
            paymentItem.className = 'payment-item mb-2 d-flex justify-content-between align-items-center';
            paymentItem.innerHTML = `
                <div>
                    ${payment.payment_type} - $${payment.amount}
                </div>
                <div>
                    <button type="button" class="btn btn-danger btn-sm delete-payment" data-payment-id="${payment.id}" data-app-id="${appId}">Delete</button>
                </div>
            `;
            paymentList.appendChild(paymentItem);
        });

        paymentList.querySelectorAll('.delete-payment').forEach(button => {
            button.addEventListener('click', function() {
                const paymentId = this.dataset.paymentId;
                const appId = this.dataset.appId;

                fetch(`/apps/delete-payment/${paymentId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}', // Include the CSRF token
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alertMessage("Payment Deleted", 'alert alert-success');
                        loadPayments(appId); // Reload the payments list
                    } else {
                        alertMessage("Error: " + (data.error || "Failed to delete payment"), 'alert alert-danger');
                    }
                })
                .catch(error => console.error('Error deleting payment:', error));
            });
        });
    })
    .catch(error => console.error('Error loading payments:', error));
}
function loadModels(appId, aceEditorInstance) {
    fetch(`/apps/fetch/${appId}/models/`)
    .then(response => response.json())
    .then(data => {
        if (data.success === false) {
            alertMessage('Error loading models: ' + data.error, 'alert alert-danger');
            console.error('Error:', data.error);
            return;
        }
        
        // Clear the editor before loading new content
        aceEditorInstance.setValue('', -1); // Clears the editor
        
        // Load the new models_code into the editor
        aceEditorInstance.setValue(data.models_code, -1); // Load new data
    })
    .catch(error => {
        console.error('Error:', error);
        alertMessage('Error loading models', 'alert alert-danger');
    });
}



function hideModal(ModalId) {
        $(ModalId).removeClass('show'); // Remove the 'show' class
        $(ModalId).css('display', ''); // Reset the display property

        // Remove the backdrop manually
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
   
}

function createAndShowModal(appId) {

    currentAppId = appId;
    
    const modalId = `modelModal-${appId}`;
    const editorId = `loadModelsEditor-${appId}`; // Unique editor ID for each app
    
    // Check if modal already exists
    if (!document.getElementById(modalId)) {
        // Modal HTML
        const modalHTML = `
            <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="modelModalLabel-${appId}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modelModalLabel-${appId}">Manage Models for App ${appId}</h5>
                            <button type="button" class="btn-close" onclick="hideModal('#${modalId}')"></button>
                        </div>
                        <div class="modal-body">
                            <button type="button" class="btn btn-secondary" onclick="showAddClassNameModal()">Add New Class</button>
                            <br></br>
                            <div id="${editorId}" style="height: 300px; width: 100%;"></div> <!-- Unique editor ID -->
                            <button type="button" class="btn btn-primary mt-3" onclick="saveModels(${appId})">Save Models</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Append to body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // Show the modal
    const modalElement = document.getElementById(modalId);
    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    // Initialize or reinitialize Ace Editor
    let aceEditorInstance = ace.edit(editorId);
    aceEditorInstance.setTheme("ace/theme/monokai");
    aceEditorInstance.session.setMode("ace/mode/python");

    // Ensure editor is resized when modal is shown
    modalElement.addEventListener('shown.bs.modal', function () {
        aceEditorInstance.resize();
        aceEditorInstance.renderer.updateFull();
    });

    // Fetch and load models data into the Ace Editor
    loadModels(appId, aceEditorInstance);
}

function addFunctionModal(appId) {
    loadFunctions(appId);
    currentAppId = appId; // Set the current app ID
}

function hideAddClassNameModal() {
    hideModal(`#addClassNameModal`)
    createAndShowModal(currentAppId)
}
function hideAddFunctionModal() {
    hideModal(`#addFunctionModal`)
    loadFunctions(currentAppId)
}

function showModelsModal(appId) {
    createAndShowModal(appId);
    currentAppId = appId; // Set the current app ID
}


function showAddClassNameModal() {
    hideModal(`#modelModal-${currentAppId}`)
    const modalElement = document.getElementById('addClassNameModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

function showAddFieldsModal() {
    var className = document.getElementById('className').value.trim();
    if (className) {
        // Hide Add Class Name Modal
        var addClassNameModalElement = document.getElementById('addClassNameModal');
        if (addClassNameModalElement) {
            hideModal(`#addClassNameModal`)
        } else {
            console.error('Add Class Name Modal element not found');
        }

        currentClassName = className;  // Store the class name in the global variable

        // Show Add Fields Modal
        var addFieldsModalElement = document.getElementById('addFieldsModal');
        if (addFieldsModalElement) {
            var addFieldsModal = new bootstrap.Modal(addFieldsModalElement);
            addFieldsModal.show();
        } else {
            console.error('Add Fields Modal element not found');
        }
    } else {
        alert('Please enter a class name.');
    }
}



// Function to set the current appId when the modal is opened
function setAppId(appId) {
    currentAppId = appId;
}

function addFieldToClass(type) {
    if (currentAppId === null) {
        console.error("No app ID set.");
        return;
    }

    const editor = document.getElementById('modelEditorDisplay');
    let fieldCode = '';

    switch (type) {
        case 'text':
            fieldCode = '\n    text_field = models.CharField(max_length=255)';
            break;
        case 'textarea':
            fieldCode = '\n    textarea_field = models.TextField()';
            break;
        case 'integer':
            fieldCode = '\n    integer_field = models.IntegerField()';
            break;
        case 'decimal':
            fieldCode = '\n    decimal_field = models.DecimalField(max_digits=10, decimal_places=2)';
            break;
        case 'float':
            fieldCode = '\n    float_field = models.FloatField()';
            break;
        case 'date':
            fieldCode = '\n    date_field = models.DateField()';
            break;
        case 'datetime':
            fieldCode = '\n    datetime_field = models.DateTimeField()';
            break;
        case 'boolean':
            fieldCode = '\n    boolean_field = models.BooleanField(default=False)';
            break;
        case 'image':
            fieldCode = '\n    image_field = models.ImageField(upload_to="images/")';
            break;
        case 'file':
            fieldCode = '\n    file_field = models.FileField(upload_to="files/")';
            break;
        case 'password':
            fieldCode = '\n    password_field = models.CharField(max_length=128, help_text="Password")';
            break;
        case 'email':
            fieldCode = '\n    email_field = models.EmailField()';
            break;
        case 'url':
            fieldCode = '\n    url_field = models.URLField()';
            break;
        case 'slug':
            fieldCode = '\n    slug_field = models.SlugField(max_length=255, unique=True)';
            break;        // Add more cases for additional field types
    }
    editor.value += fieldCode;
}

function hideAllModals() {
    $('.modal.show').each(function() {
        $(this).removeClass('show'); // Remove the 'show' class
        $(this).css('display', ''); // Reset the display property

        // Remove the backdrop manually
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    });
}

function saveClassToEditor() {
    if (currentAppId === null) {
        console.error("No app ID set.");
        return;
    }

    // Ensure the class name is set and stored in the global variable
    if (!currentClassName) {
        alert("Please enter a class name.");
        return;
    }

    const editor = document.getElementById('modelEditorDisplay');
    if (!editor) {
        console.error("Editor element not found.");
        return;
    }

    const modelCode = `class ${currentClassName}(models.Model):\n${editor.value}`;

    fetch(`/apps/${currentAppId}/save_class/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')  // Ensure this function is correctly defined
        },
        body: JSON.stringify({
            appId: currentAppId,
            modelCode: modelCode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideAllModals();
            $('#addFieldsModal').modal('hide');
            loadModels(currentAppId)

            showModelsModal(currentAppId);

            alertMessage("Class saved successfully!", 'alert alert-success');
        } else {
            alert(`Failed to save class: ${data.error}`);
        }
    })
    .catch(error => console.error('Error:', error));
}


function saveModels(appId) {
    const editor = document.getElementById(`modelEditor-${appId}`);
    const modelCode = editor.value;

    // Make an AJAX request to save the model code
    fetch(`/apps/${appId}/save_models/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // Ensure you include the CSRF token
        },
        body: JSON.stringify({ model_code: modelCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideAllModals();
            alertMessage('Models saved successfully', 'alert alert-success');
        } else {
            alertMessage('Error saving models: ' + data.error, 'alert alert-danger');
        }
    })
    .catch(error => console.error('Error:', error));
}

let conversationContext = [];  // This will store the entire chat history
function isCode(response) {
    // Check for common code block delimiters
    const codeBlockPatterns = [
        /```/,                // Markdown code block delimiter
        /<code>/,             // HTML <code> tag
        /<pre>/               // HTML <pre> tag
    ];

    // Check if response contains any of the code block patterns
    return codeBlockPatterns.some(pattern => pattern.test(response));
}
document.getElementById('sendOpenAIMessage').addEventListener('click', function() {
    const messageInput = document.getElementById('openAIInput');
    const messageText = messageInput.value.trim();
    const chatContainer = document.getElementById('openAIChat');

    if (messageText) {
        // Add the user's message to the conversation context
        conversationContext.push({ role: 'user', content: messageText });

        // Display the user's message in the chat
        const userMessage = document.createElement('div');
        userMessage.textContent = `You: ${messageText}`;
        userMessage.classList.add('text-primary', 'mb-2');
        chatContainer.appendChild(userMessage);
        chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom

        // Send the conversation context to OpenAI
        fetch('/open_ai/function-convertion/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()  // Assuming you have a CSRF token function
            },
            body: JSON.stringify({ conversation: conversationContext })
        })
        .then(response => response.json())
        .then(data => {
            if (data.response) {
                // Add OpenAI's response to the conversation context
                conversationContext.push({ role: 'assistant', content: data.response });

                // Split the response into text and code blocks
                const parts = splitResponse(data.response);

                // Create a container for OpenAI's response
                const aiMessageContainer = document.createElement('div');
                aiMessageContainer.classList.add('mb-2');
                chatContainer.appendChild(aiMessageContainer);

                // Display text and code blocks
                parts.forEach(part => {
                    if (part.type === 'text') {
                        const aiTextMessage = document.createElement('div');
                        aiTextMessage.textContent = `OpenAI: ${part.content}`;
                        aiTextMessage.classList.add('text-success', 'mb-2');
                        aiMessageContainer.appendChild(aiTextMessage);
                    } else if (part.type === 'code') {
                        // Create and initialize the Ace Editor instance
                        const editorDiv = document.createElement('div');
                        editorDiv.style.height = '200px';
                        editorDiv.style.width = '100%';
                        editorDiv.classList.add('ace-editor-instance');
                        
                        aiMessageContainer.appendChild(editorDiv);

                        // Initialize Ace Editor
                        const editor = ace.edit(editorDiv);
                        editor.setTheme('ace/theme/monokai');
                        editor.session.setMode('ace/mode/javascript');  // Set mode to JavaScript, adjust if needed
                        editor.setValue(part.content);
                    }
                });

                chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom
            }
        })
        .catch(error => {
            console.error('Error communicating with OpenAI:', error);
        });

        // Clear the input field
        messageInput.value = '';
    }
});

// Function to split the response into text and code blocks
function splitResponse(response) {
    const codeDelimiter = '```'; // Use your delimiter
    const parts = [];
    let lastIndex = 0;

    while (true) {
        const start = response.indexOf(codeDelimiter, lastIndex);
        if (start === -1) break;

        // Add text before the code block
        if (start > lastIndex) {
            parts.push({ type: 'text', content: response.slice(lastIndex, start).trim() });
        }

        lastIndex = start + codeDelimiter.length;
        const end = response.indexOf(codeDelimiter, lastIndex);
        if (end === -1) break;

        // Add the code block
        parts.push({ type: 'code', content: response.slice(lastIndex, end).trim() });

        lastIndex = end + codeDelimiter.length;
    }

    // Add any remaining text after the last code block
    if (lastIndex < response.length) {
        parts.push({ type: 'text', content: response.slice(lastIndex).trim() });
    }

    return parts;
}
async function getModelDefinitions(appId, selectedModels) {
    try {
        const response = await fetch(`/apps/get-model-definitions/${appId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()  // Ensure you include CSRF token if needed
            },
            body: JSON.stringify({ models: selectedModels })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.models) {
                return data.models;
            } else {
                console.error('Error fetching model definitions:', data.error);
                return null;
            }
        } else {
            console.error('Error fetching model definitions:', response.statusText);
            return null;
        }
    } catch (error) {
        console.error('Error during fetch:', error);
        return null;
    }
}
// Get selected models from the buttons
function getSelectedModels() {
    const selectedButtons = document.querySelectorAll('button[data-selected="true"]');
    return Array.from(selectedButtons).map(button => button.value);
}

// Generate prompt and send it to OpenAI when user clicks the generate button
document.getElementById('generateFromOpenAI').addEventListener('click', async function() {
    const functionName = document.getElementById('functionName').value.trim();
    const inputPathPart = document.getElementById('inputPathPart').value.trim();
    const inputViewPart = document.getElementById('inputViewPart').value.trim();
    const inputNamePart = document.getElementById('inputNamePart').value.trim();
    const functionDescription = document.getElementById('functionDescription').value.trim();
    
    // Get selected models using button-based selection
    const selectedModels = getSelectedModels();
    const appId = currentAppId;

    // Fetch model definitions
    const modelDefinitions = await getModelDefinitions(appId, selectedModels);
    
    if (functionName && functionDescription && modelDefinitions) {
        const functionURLResult = `path('${inputPathPart}/', views.${inputViewPart}, name='${inputNamePart}')`;

        const prompt = `
            Please generate a Python function for my Django project based on the following details:
            
            Function Name: ${functionName}
            URL: ${functionURLResult}
            Description: ${functionDescription}
            Models: ${JSON.stringify(modelDefinitions, null, 2)}
            
            Please and thank you.
        `;

        const chatContainer = document.getElementById('openAIChat');

        // Display the prompt in the chat
        const userMessage = document.createElement('div');
        userMessage.textContent = `You: ${prompt}`;
        userMessage.classList.add('text-primary', 'mb-2');
        chatContainer.appendChild(userMessage);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Send the prompt to OpenAI
        fetch('/open_ai/function-chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ message: prompt })
        })
        .then(response => response.json())
        .then(data => {
            if (data.response) {
                const parts = splitResponse(data.response);

                const aiMessageContainer = document.createElement('div');
                aiMessageContainer.classList.add('mb-2');
                chatContainer.appendChild(aiMessageContainer);

                parts.forEach(part => {
                    if (part.type === 'text') {
                        const aiTextMessage = document.createElement('div');
                        aiTextMessage.textContent = `OpenAI: ${part.content}`;
                        aiTextMessage.classList.add('text-success', 'mb-2');
                        aiMessageContainer.appendChild(aiTextMessage);
                    } else if (part.type === 'code') {
                        const editorDiv = document.createElement('div');
                        editorDiv.style.height = '200px';
                        editorDiv.style.width = '100%';
                        editorDiv.classList.add('ace-editor-instance');
                        
                        aiMessageContainer.appendChild(editorDiv);

                        const editor = ace.edit(editorDiv);
                        editor.setTheme('ace/theme/monokai');
                        editor.session.setMode('ace/mode/python');
                        editor.setValue(part.content);
                    }
                });

                chatContainer.scrollTop = chatContainer.scrollHeight;

            }
        })
        .catch(error => {
            console.error('Error communicating with OpenAI:', error);
        });
    } else {
        alert("Please fill in the function name and description.");
    }
});

function submitFunctionForm() {
    // Prevent default form submission behavior
    event.preventDefault();
    
    const formData = new FormData();
    
    // Get elements with safety checks
    const inputPathPartElement = document.getElementById('inputPathPart');
    const inputViewPartElement = document.getElementById('inputViewPart');
    const inputNamePartElement = document.getElementById('inputNamePart');

    const inputPathPart = inputPathPartElement ? inputPathPartElement.textContent.trim() : '';
    const inputViewPart = inputViewPartElement ? inputViewPartElement.textContent.trim() : '';
    const inputNamePart = inputNamePartElement ? inputNamePartElement.textContent.trim() : '';

    // Construct the function result string
    const functionUrlResult = `path('${inputPathPart}/', views.${inputViewPart}, name='${inputNamePart}')`;

    // Manually append necessary fields to formData
    formData.append('name', document.getElementById('functionName').value);
    formData.append('description', document.getElementById('functionDescription').value);
    formData.append('url', functionUrlResult);

    // Send the data via AJAX
    fetch(`/apps/${currentAppId}/functions/add/`, {  
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken() // Ensure CSRF token is included
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alertMessage('Function saved successfully!', 'alert alert-success');
            document.getElementById('addFunctionForm').reset();
            hideModal('#addFunctionModal')
            editFunction(data.function_id)
        } else {
            // Display errors directly within the modal
            const errorMessages = data.errors || ["An unknown error occurred."];
            displayErrors(errorMessages);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        displayErrors([error.message]);
    });
}


function formatUrl(url) {
    // Style "path" with yellow
    url = url.replace(/^path/, `<span class="keyword">path</span>`);

    // Style the word after "views." with yellow
    url = url.replace(/views\.(\w+)/, `views.<span class="keyword">$1</span>`);

    // Style the word "views" with green
    url = url.replace(/views/g, `<span class="views">views</span>`);

    // Style the word "name" with blue
    url = url.replace(/name/g, `<span class="name">name</span>`);

    // Style text inside single quotes with brown
    url = url.replace(/'([^']*)'/g, `<span class="quote">'$1'</span>`);

    // Style parentheses with purple
    url = url.replace(/\(/g, `<span class="parenthesis">(</span>`);
    url = url.replace(/\)/g, `<span class="parenthesis">)</span>`);

    return url;
}

function formatPackages(packages) {
    // Get the container where you want to append the styled package elements
    const functionPackagesDiv = document.getElementById('functionPackages');
    functionPackagesDiv.innerHTML = ''; // Clear previous content

    packages.forEach(pkg => {
        let styledText = pkg;

        if (pkg.startsWith('from ')) {
            styledText = pkg
                .replace(/(from\s+)(.*)/, '<span class="package-keyword-from">$1</span><span class="package-after-from">$2</span>')
                .replace(/(import\s+)(.*)/, '<span class="package-keyword-import">$1</span><span class="package-after-import">$2</span>');
        } else if (pkg.startsWith('import ')) {
            styledText = pkg
            .replace(/(import\s+)(.*)/, '<span class="package-keyword-import">$1</span><span class="package-after-import">$2</span>');
        }

        // Create and append the styled package element
        const packageElement = document.createElement('div');
        packageElement.innerHTML = styledText;
        functionPackagesDiv.appendChild(packageElement);
    });
}




function editFunctionCloseButton() {
    hideModal(`#editFunctionModal`);
    loadFunctions(currentAppId);
}

let editFunctionEditor;
function editFunction(id) {
    // Use AJAX to get the data for the function
    fetch(`/apps/function/${id}/json/`)
        .then(response => response.json())
        .then(data => {
            // Populate the text element and other form fields with the data
            document.getElementById('editFunctionId').value = data.id;
            document.getElementById('editFunctionName').textContent = data.name;
            document.getElementById('editFunctionDescription').value = data.description;
            document.getElementById('editFunctionUrl').innerHTML = formatUrl(data.url);

            // Initialize Ace Editor if it hasn't been initialized yet
            if (!editFunctionEditor) {
                const editorElement = document.getElementById("editFunctionCodeEditor");
                editFunctionEditor = ace.edit(editorElement);
                editFunctionEditor.setTheme("ace/theme/monokai");
                editFunctionEditor.session.setMode("ace/mode/python");

                // Handle changes to enforce read-only behavior for the first line
                editFunctionEditor.selection.on('changeCursor', function(e) {
                    if (editFunctionEditor.selection.getCursor().row === 0) {
                        editFunctionEditor.selection.moveTo(1, 0);
                    }
                });
            }

            // Populate the functionPackages div
            const functionPackagesDiv = document.getElementById('functionPackages');
            const newPackageFieldsDiv = document.getElementById('newPackageFields');
            functionPackagesDiv.innerHTML = ''; // Clear previous content
            newPackageFieldsDiv.innerHTML = ''; // Clear the contents

            // Handle data.packages based on its type
            let packages = [];
            if (Array.isArray(data.packages)) {
                packages = data.packages;
            } else if (typeof data.packages === 'string') {
                try {
                    packages = JSON.parse(data.packages);
                    if (!Array.isArray(packages)) {
                        packages = [packages]; // Wrap in an array if it's not an array
                    }
                } catch (e) {
                    console.error('Error parsing data.packages string:', e);
                    packages = [data.packages]; // Fallback to treating as a single package
                }
            }

            formatPackages(packages);

            editFunctionEditor.setValue(data.code, -1);
            

            // Open the modal
            hideModal(`#functionsModal`);
            const editFunctionModal = document.getElementById('editFunctionModal');
            const modal = new bootstrap.Modal(editFunctionModal);
            modal.show();

        })
        .catch(error => console.error('Error:', error));
}


function submitEditFunctionForm() {
    const form = document.getElementById('editFunctionForm');
    const formData = new FormData(form);
    
    // Get the function code from the Ace Editor and append it to the formData
    const functionCode = editFunctionEditor.getValue();
    formData.append('code', functionCode);

    // Collect packages from the newFunctionPackages div
    const newFunctionPackagesDiv = document.getElementById('newFunctionPackages');
    const packageElements = newFunctionPackagesDiv.querySelectorAll('.package-item');
    console.info(packageElements)
    const packages = Array.from(packageElements).map(element => {
        let packageText = element.textContent.trim();
        // Format package text to match the desired structure
        if (packageText.startsWith('from ')) {
            return packageText.replace(/^(from\s+)(.*)/, 'from $2');
        } else if (packageText.startsWith('import ')) {
            return packageText.replace(/^(import\s+)(.*)/, 'import $2');
        }
        return packageText;
    });
    console.info(packages)
    // Append packages to formData as a JSON string
    formData.append('packages', JSON.stringify(packages));

    fetch(`/apps/function/${formData.get('function_id')}/edit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            packageElements.forEach(element => element.remove());

            hideModal(`#editFunctionModal`);
            loadFunctions(currentAppId);
            alertMessage('Edit Function Successfully!', 'alert alert-success');
        } else {
            // Handle validation errors
            console.error('An error occurred while saving the function.');
            alertMessage('An error occurred while saving the function.', 'alert alert-danger');
        }
    })
    .catch(error => console.error('Error:', error));
}

function displayErrors(errors) {
    const errorContainer = document.createElement('div');
    errorContainer.className = 'alert alert-danger';
    errorContainer.innerHTML = errors.map(error => `<p>${error}</p>`).join('');
    
    // Clear any previous errors
    const existingErrors = document.querySelector('.modal-body .alert-danger');
    if (existingErrors) {
        existingErrors.remove();
    }

    // Append the new errors to the modal body
    document.querySelector('.modal-body').prepend(errorContainer);
}

document.getElementById('addPackageLink').addEventListener('click', (event) => {
    event.preventDefault(); // Prevent default link behavior

    const newPackageFieldsDiv = document.getElementById('newPackageFields');

    // Toggle the visibility of the input field and "Add" link
    if (newPackageFieldsDiv.style.display === 'none') {
        // Show input field and "Add" link
        newPackageFieldsDiv.style.display = 'flex';

        // Check if input field and "Add" link are already added
        if (newPackageFieldsDiv.children.length === 0) {
            const packageInput = document.createElement('input');
            packageInput.type = 'text';
            packageInput.className = 'form-control';
            packageInput.placeholder = 'Enter package';

            const addButton = document.createElement('a');
            addButton.href = '#';
            addButton.className = 'btn btn-success';
            addButton.textContent = 'Add';

            // Add an event listener to the "Add" link
            addButton.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default link behavior
                const packageValue = packageInput.value.trim();
                if (packageValue) {
                    fetch('/apps/install-pip-package/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ package_name: packageValue })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const newFunctionPackagesDiv = document.getElementById('newFunctionPackages');

                            // Create a new div element to display the package
                            const packageElement = document.createElement('div');
                            packageElement.className = 'package-item';

                            // Format the package text with styling
                            let styledText = packageValue;
                            if (packageValue.startsWith('from ')) {
                                styledText = packageValue
                                    .replace(/(from\s+)(.*)/, '<span class="package-keyword-from">$1</span><span class="package-after-from">$2</span>')
                                    .replace(/(import\s+)(.*)/, '<span class="package-keyword-import">$1</span><span class="package-after-import">$2</span>');
                            } else if (packageValue.startsWith('import ')) {
                                styledText = packageValue
                                    .replace(/(import\s+)(.*)/, '<span class="package-keyword-import">$1</span><span class="package-after-import">$2</span>');
                            }

                            packageElement.innerHTML = styledText;

                            // Append the new package element to the newFunctionPackages div
                            newFunctionPackagesDiv.appendChild(packageElement);

                        } else {
                            alert(`Failed to install package: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while installing the package.');
                    });

                    packageInput.value = ''; // Clear the input field
                }
            });

            // Append the input field and link to the newPackageFields div
            newPackageFieldsDiv.appendChild(packageInput);
            newPackageFieldsDiv.appendChild(addButton);
        }
    } else {
        // Hide the input field and "Add" link
        newPackageFieldsDiv.style.display = 'none';
        newPackageFieldsDiv.innerHTML = ''; // Clear the contents
    }
});




</script>
